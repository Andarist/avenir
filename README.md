# avenir

Lightweight async library based on lazy futures. Inspired by [folktale's Data.Task](https://github.com/folktale/data.task)

The library provides `Tasks` for writing asynchronous code with JavaScript in
Node and the Browser.

Unlike Promises, the standard async abstraction, Tasks are _lazy_ and _cancellable_.

Unlike Data.Task you can join results from other running Tasks which provides the
same multiple-consumer model of promises (attaching multiple thenables).

However, Tasks provides a strict ownership model of the control flow : The runner
of the  Task can cancel the running Task but the joiners of the running Task can not
cancel it, they only can unsubscribe from its outcome. This simplifies cancellation
semantics and avoids non trivial solutions provided by other multi-consumer solutions
(like reference counting).

### Tasks are Lazy

When you create and combine Tasks using various methods (`then`, `all`, `race`),
The executor of the Task is not started which means no side effect takes place at this
moment. To effectively start a Task, you must invoke its `run` method

```js
// Nothing happens here
const sumTask =
    delay(1000, 10).then(x =>
    delay(1000, 20).then(y =>
     x + y
    ))

// Execution starts from here
const future = sumTask.run(onSuccess, onError, onCancel)
```

### Tasks are Cancellable

After a Task has been started, it can be cancelled using the returned Future

```js
// using Generator syntax
const sumTask = Task.do(function*() {
    const x = yield delay(1000, 10)
    const y = yield delay(1000, 20)
    return x + y
})

// Execution starts from here
const future = sumTask.run(onSuccess, onError, onCancel)

// ... after some time
future.cancel('some reason')
```

### Tasks are Joinable

A task can join the result of another started Task

```js
const loginTask = Task.do(function*() {
  // ...
})

// fork run the task and returns the future of the Task
const loginFuture = loginTask.fork()

// The owner of the future can cancel it
cancelLoginButton.addEventListener(() => loginFuture.cancel('by user'))


// An auxiliary task
const fetchTask = Task.do(function*() {
  /*
    wait for login to complete.
    Rejection/cancellation of loginFuture will reject/cancel fetchTask
  */
  yield Task.join(loginFuture)
  // ... continue here
})
```

# API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

## Task

**Parameters**

-   `getFuture`  

### constructor

Creates a Task from a function that returns a Future.

**Parameters**

-   `getFuture` **[Function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)** A function which returns a [Future](#future)

### run

Starts executing the Task. No side effect will take place until this method
is invoked. Returns a [Future](#future) representing the outcome of the Task.

A started task can be cancelled by invoking [Future#cancel](#futurecancel) on the
returned Future. Cancelling a Task will cancel the the currently executing
step and will skip all subsequent steps.

**Parameters**

-   `onSuccess` **[Function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)?** callback invoked if the Task has succeded (optional, default `noop`)
-   `onError` **[Function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)?** callback invoked if the Task has aborted. If
    not provided an Exception will be thrown (optional, default `raise`)
-   `onCancel` **[Function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)?** callback invoked if the Task was cancelled (optional, default `noop`)

Returns **[Future](#future)** 

### orElse

Run a race between the 2 proivded Tasks. Returns a new Task that will

-   resolve with the value of the first resolved input Task
-   reject with the error of the first rejected input Task. The other Task
    will be cancelled.
-   If the 2 input Tasks are cancelled, the Task wil be cancelled with reason
    of the last cancelled Task.

**Parameters**

-   `task` **[Task](#task)** a Task that this task will be raced against

Returns **[Task](#task)** 

### then

Chains a callback that will run after this Task completes. Each of the 3
chained callbacks can return another Task to execute further actions.
returning a non Task value from a callback has the same effect as returning
`Task.resolve(value)`.

Note that unlike [Task#run](#taskrun), this method doesn't start the execution
of the Task. All it does is to construct a new Task that, when started,
will run in sequence the two tasks (this Task and the one returned by the
invoked callback).

The current Task will invoke the appropriate callback corresponding
to the type of its outcome (success, error or cancellation). Each callback
is optional. In case the corresponding callback was not provided, the final
outcome will be the same as the first Task.

This method returns a new Task that will complete with the same outcome
as the second Task returned from the appropriate callback.

**Parameters**

-   `onSuccess` **[Function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)?** callback invoked if the Task has succeded
-   `onError` **[Function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)?** callback invoked if the Task has aborted. If
-   `onCancel` **[Function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)?** callback invoked if the Task was cancelled

Returns **[Task](#task)** 

### log

a helper method to debug Tasks. It will log the outcome of the Task in the
console. All log messages will be prefixed withe provided string.

This method returns a [Future](#future) that represent the outcome of the Task.

**Parameters**

-   `prefix` **[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** used to prefix logged messages

Returns **[Future](#future)** 

### of

Returns a Task that will always resolve with the provided value

**Parameters**

-   `value` **any** 

Returns **[Task](#task)** 

### resolve

Same as [Task.of](#taskof) \*

**Parameters**

-   `value`  

### reject

Returns a Task that will always reject with the provided value

**Parameters**

-   `error` **any** 

Returns **[Task](#task)** 

### cancel

Returns a Task that will always be cancelled with the provided value

**Parameters**

-   `reason` **any** 

Returns **[Task](#task)** 

### from

Creates a Task that, when started, will get its outcome using the provided
executor function.

Each time the Task is started using [Task.run](Task.run), the executor function
will be invoked with 3 callbacks: resolve, reject and cancel. The executor
function must invoke the appropriate callback to notify the Task's outcome.

Task's executors are invoked synchrously (immediately).

**Parameters**

-   `executor` **[executor](#executor)** 

Returns **any** Task

### join

Creates a Task that will be complete with the same outcome as the provided
Future.

Note that cancelling the execution of the returned task will not cancel
the original Future.

**Parameters**

-   `future`  

Returns **any** Task

### empty

Returns a Task that does nothing. An empty task doesn't have an outcome.

In particular an empty task has the following properties (≅ means the 2 tasks
behave in similar ways)

emptyTask.orElse(anotherTask)         ≅ anotherTask
anotherTask.orElse(emptyTask)         ≅ anotherTask
emptyTask.then(_ => anotherTask)      ≅ emptyTask
anotherTask.then(_ => emptyTask)      ≅ emptyTask
Task.zipw(f, emptyTask, anotherTask)  ≅ emptyTask
Task.zipw(f, anotherTask, emptyTask)  ≅ emptyTask

Returns **any** Task

### race2

Same as [Task#orElse](#taskorelse) task1.orElse(task2) \*

**Parameters**

-   `task1`  
-   `task2`  

### race

Runs a race between all the provided Tasks. This is the same as

task1.orElse(task2)......orElse(taskN)

**Parameters**

-   `tasks` **[Array](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[Task](#task)>** 

Returns **any** Task

### zipw

Combine the resolved outcomes of 2 input Tasks using the provided function.

If one of the input Tasks is rejected/cancelled, then the result Task
will be rejected/cancelled a well. The other Task will also be automatically
cancelled.

**Parameters**

-   `f` **[Function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)** Used to combine the resolved values of the 2 tasks
-   `task1`  
-   `task2`  
-   `Task` **task1** 
-   `Task` **task2** 

Returns **any** Task

### all

Returns a Task that will resolve with Array of all values if all input tasks
are resolved. If an input Task is rejected/cancelled, the result Task will
also be rejected/cancelled and all Tasks that are still pending will be
automatically cancelled.

**Parameters**

-   `tasks` **[Array](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[Task](#task)>** 

Returns **any** Task

### apply

Returns a Task that will applies the provided function to the resolved values
of the input Tasks. The Task will be rejected/cancelled if any of the input
Tasks is rejected/cancelled and the other Tasks will be cancelled if still
pending.

**Parameters**

-   `f` **[Function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)** 
-   `tasks` **[Array](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[Task](#task)>** 
-   `ctx` **[object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** If provided, will be used as a `this` for the function

### lift

Transforms a function that acts on plain values to a function that acts on
Tasks. This is the same as `Task.apply.bind(undefined, f)`

**Parameters**

-   `f`  

## executor

This function is used to execute the an action for a given [Task](#task) or
[Future](#future), and then notifies the appropriate provided callbac (success,
error or cancellation)

Type: [Function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)

**Parameters**

-   `resolve` **[Function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)** Invoke this callback to resolve the Task/Future
-   `reject` **[Function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)** Invoke this callback to reject the Task/Future
-   `cancel` **[Function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)** Invoke this callback to cancel the Task/Future

## Future

**Parameters**

-   `executor`  

### constructor

Creates a Future that will get its outcome using the provided
[executor](#executor) function.

Future's executors are invoked synchrously (immediately).

**Parameters**

-   `executor` **[executor](#executor)** 

Returns **any** Future

### subscribe

Attach callbacks to be invoked once the Future is resolved/rejected/cancelled.

Returns a function that can be used to cancel the subscription.

**Parameters**

-   `onSuccess` **[Function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)?** callback invoked if the Future has succeded
-   `onError` **[Function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)?** callback invoked if the Future has aborted. If (optional, default `noop`)
-   `onCancel` **[Function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)?** callback invoked if the Future was cancelled (optional, default `noop`)

Returns **[Function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)** a function that can be used to cancel the subscription.

### fork

Returns a new Future that will complete with the same outcome as the input
Future.

Cancelling this Future will not cancel the original Future.

### cancel

Cancels the Future with provided reason. Cancellation _forces_ the outcome
of this Future into a Cancelled state.

Cancellation will be notified to all subscribers that have provided an
`onCancel` callback.

**Parameters**

-   `reason` **any** 

### of

Creates a Future that is resolved with the provided value

**Parameters**

-   `value` **any** 

Returns **any** Future

### resolve

Same as [Future.of](#futureof)

**Parameters**

-   `a`  

### reject

Creates a Future that is rejected with the provided error

**Parameters**

-   `error` **any** 

Returns **any** Future

### cancel

Creates a Future that is cancelled with the provided reason

**Parameters**

-   `reason` **any** 

Returns **any** Future

### empty

Creates a Future that never completes
